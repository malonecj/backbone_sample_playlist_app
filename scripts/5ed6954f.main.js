!function(a){var b=new Marionette.Application;b.addRegions({searchBoxRegion:"#searchBoxRegion",sidebarRegion:"#sidebarRegion",mainRegion:"#mainRegion",footerRegion:"#footerRegion",loaderRegion:"#loaderRegion"}),a.PlaylistApp=b}(window),function(){PlaylistApp.module("Shared.Mixins",function(a,b,c,d,e){a.Api={searchUrlRoot:"https://api.spotify.com/v1/search/",validateQuery:function(a){return"artist"!==a&&"album"!==a&&"track"!==a?!1:!0},apiSearch:function(a,b,c){if(!this.validateQuery(b))throw"Metadata API must query either an artist, album or track";{var d=this.searchUrlRoot+"?q="+a+"&type="+b;e.ajax(d).done(c).fail(function(){console.log("error searching for "+a)})}}}})}(this),function(){PlaylistApp.module("Entities",function(a,b,c){a.AlbumCollection=c.Collection.extend({model:a.Artist,apiObject:"artist",filterValidAlbumsByTerritory:function(a){return this.filter(function(b){return b.get("availability").terretories.indexOf(a)>-1})}})})}(this),function(){PlaylistApp.module("Entities",function(a,b,c){a.Artist=c.Model.extend({idAttribute:"href"})})}(this),function(){PlaylistApp.module("Entities",function(a,b,c,d,e,f){a.ImageEmbed=c.Model.extend({getImageDetails:function(a,b){url="https://embed.spotify.com/oembed/?url="+a+"&callback=?",e.getJSON(url,function(a){this.set(a),f.isFunction(b)&&b(this)}.bind(this))}})})}(this),function(){PlaylistApp.module("Entities",function(a,b,c,d,e,f){a.ArtistCollection=c.Collection.extend(f.extend({},b.Shared.Mixins.Api,{model:a.Artist,apiObject:"artist",search:function(a){this.apiSearch(a,this.apiObject,this.onArtistsRetrieved.bind(this))},onArtistsRetrieved:function(a){this.reset(f.first(a.artists,5)),this.info=a.info}}))})}(this),function(){PlaylistApp.module("Entities",function(a,b,c,d,e){a.Track=c.Model.extend({idAttribute:"href",url:"https://api.spotify.com/v1/tracks/",lookup:function(a){this.url+=a;e.ajax(this.url).done(this.onTrackFound.bind(this)).fail(function(){console.log("error searching for "+searchText)})},onTrackFound:function(a){this.set(a)}}),a.TrackCollection=c.Collection.extend({getValidTracksByTerritory:function(){return this}})})}(this),function(){PlaylistApp.module("Search.Views",function(a,b,c){a.SearchBox=c.Marionette.ItemView.extend({template:"#search-box-tmpl",ui:{$input:"input[type=search]"},events:{"keyup input":"keyPressEventHandler"},triggers:{"change input":"search:requested","click a.btn":"search:requested"},keyPressEventHandler:function(a){13==a.keyCode&&this.trigger("search:requested",{view:this})}})})}(this),function(){PlaylistApp.module("Search",function(a){a.on("start",function(){new a.Controller})})}(this),function(){PlaylistApp.module("Search",function(a,b,c,d,e){a.Controller=d.Controller.extend({initialize:function(){var a=this.showSearchBox(),b="Alabama Shakes";this.searchForItems(b,this.onSearchComplete.bind(this)),this.listenTo(a,"search:requested",function(a){var b=a.view.ui.$input.val();return this.searchForItems(b,this.onSearchComplete.bind(this)),!1},this)},showSearchBox:function(){var c=new a.Views.SearchBox;return b.searchBoxRegion.show(c),c},searchForItems:function(a,b){this.displayLoader();{var c="https://api.spotify.com/v1/search/?q="+a+"&type=artist,album,track";e.ajax(c).done(b).fail(function(){console.log("error searching for "+searchText)})}},onSearchComplete:function(a){this.hideLoader(),b.vent.trigger("search:complete",a)},displayLoader:function(){var a=new b.Shared.Views.Loader;b.loaderRegion.show(a)},hideLoader:function(){b.loaderRegion.close()}})})}(this),function(){PlaylistApp.module("Shared.Views",function(a,b,c,d){a.Loader=d.ItemView.extend({template:"#loader-tmpl"})})}(this),function(){PlaylistApp.module("Display.Views",function(a,b,c,d,e,f){a.ArtistItem=c.Marionette.ItemView.extend({tagName:"div",className:"col-xs-4 col-md-2",template:"#search-artist-item-tmpl",ui:{$artistImage:".js-artist-img"},onRender:function(){var a=this.model.get("images"),b=f.last(f.sortBy(a,"width"));this.showThumbnail(b)},showThumbnail:function(a){this.ui.$artistImage.prop("src",a.url)}}),a.ArtistList=c.Marionette.CompositeView.extend({itemView:a.ArtistItem,template:"#search-artist-list-tmpl",itemViewContainer:"div.row"})})}(this),function(){PlaylistApp.module("Display.Views",function(a,b,c){a.Layout=c.Marionette.Layout.extend({template:"#display-layout-tmpl",regions:{artistListRegion:"#artistListRegion",trackListRegion:"#trackListRegion"}})})}(this),function(){PlaylistApp.module("Display.Views",function(a,b,c,d,e,f){a.TrackItem=c.Marionette.ItemView.extend({initialize:function(){},events:{click:"onTrackClicked"},onTrackClicked:function(){b.vent.trigger("track:selected",this.model)},tagName:"tr",className:"clickable",template:"#track-item-tmpl"}),a.TrackList=c.Marionette.CompositeView.extend({ui:{$albumImage:"img"},events:{"click tr":"playTrack"},itemView:a.TrackItem,template:"#track-list-tmpl",itemViewContainer:"tbody",onRender:function(){var a=this.model.get("images"),b=f.last(f.sortBy(a,"width"));this.showThumbnail(b)},showThumbnail:function(a){this.ui.$albumImage.prop("src",a.url)}}),Handlebars.registerHelper("songLength",function(a){a/=1e3;var b=Math.floor(a/60),c=Math.round(a%60);return 10>c&&(c="0"+c),b+":"+c}),Handlebars.registerHelper("getArtistName",function(a){return a&&a.length>0?a[0].name:void 0})})}(this),function(){PlaylistApp.module("Display.Views",function(a,b,c,d,e,f){a.AlbumList=c.Marionette.CompositeView.extend({template:"#album-container-tmpl",itemView:a.TrackList,buildItemView:function(a,b,c){var d=f.extend({model:a,collection:a.get("trackList")},c),e=new b(d);return e}})})}(this),function(){PlaylistApp.module("Display",function(a,b,c,d,e,f){var g;a.on("start",function(){g=new a.Controller}),b.vent.on("search:complete",function(a){if(a.artists){var d=f.first(f.filter(a.artists.items,function(a){return a.images.length>0}),1),e=new c.Collection(d);g.displayArtists(e)}if(a.tracks){var h=new b.Entities.TrackCollection(a.tracks.items);g.displayTracks(h)}})})}(this),function(){PlaylistApp.module("Display",function(a,b,c,d,e,f){a.Controller=d.Controller.extend({initialize:function(){this.layout=new a.Views.Layout},displayArtists:function(b){if(b.length>0){var c=new a.Views.ArtistList({collection:b});this.layout.artistListRegion.show(c)}else this.layout.artistListRegion.close()},displayTracks:function(a){a.length>0?this.displayValidTracks(a):this.layout.trackListRegion.close()},displayValidTracks:function(d){var e=d.groupBy(function(a){return a.get("album").href}),g=new b.Entities.AlbumCollection;f.each(e,function(a){var b=a[0].get("album"),d=a.sort(function(a,b){return a.get("track_number")-b.get("track_number")});b.trackList=new c.Collection(d);var e=new c.Model(b);g.add(e)});var h=new a.Views.AlbumList({collection:g});this.layout.trackListRegion.show(h)}})})}(this),function(){PlaylistApp.module("Sidebar.Views",function(a,b,c){a.Layout=c.Marionette.Layout.extend({template:"#sidebar-tmpl",regions:{nowPlayingRegion:"#nowPlayingRegion"}})})}(this),function(){PlaylistApp.module("Sidebar.Views",function(a,b,c){a.TrackPlayer=c.Marionette.ItemView.extend({template:"#now-playing-tmpl",ui:{image:"img",musicSource:"source",player:"audio"},initialize:function(){this.listenTo(this.model,"change",this.render,this)},onRender:function(){this.loadAlbumImage(),this.loadTrackPreview()},loadAlbumImage:function(){var a=this.model.get("album");if(a){var b=a.images[0];this.ui.image.prop("src",b.url)}},loadTrackPreview:function(){var a=this.model.get("preview_url");this.ui.musicSource.prop("src",a)},play:function(){this.ui.player[0].play()}})})}(this),function(){PlaylistApp.module("Sidebar",function(a,b,c,d){a.Controller=d.Controller.extend({initialize:function(){this.layout=new a.Views.Layout,b.sidebarRegion.show(this.layout),this.currentTrack=new b.Entities.Track,this.trackPlayer=new a.Views.TrackPlayer({model:this.currentTrack}),this.layout.nowPlayingRegion.show(this.trackPlayer),this.loadInitialTrack(),this.delegateEvents()},delegateEvents:function(){this.listenTo(b.vent,"track:selected",this.playTrack,this)},loadInitialTrack:function(){this.currentTrack.lookup("1gGY6qfslDtJ4OoWQGKtkE")},playTrack:function(a){var b=a.toJSON();this.currentTrack.set(b),this.trackPlayer.play()}})})}(this),function(){PlaylistApp.module("Sidebar",function(a){var b;a.on("start",function(){b=new a.Controller})})}(this),this.JST=this.JST||{};